# 02_반환 타입을 DTO로 해야하는 이유

> API의 Response 응답 반환 타입을 DTO로 해야하는 이유

보통 DTO를 응답 반환 타입으로 사용한다. 그런데 왜 그래야만 할까? DTO를 사용하지 않으면 무슨 일이 발생할까?

## 1. JSON Serialization Infinite Loop

> "Document nesting depth (1001) exceeds the maximum allowed..."

무한 참조; 엔티티 자체를 반환하려고 할 경우 발생하는 문제점

### 1) 원인

#### (1) 양방향 연관 관계

엔티티 간에 서로 양방향 참조를 하고 있는데, 엔티티 자체를 응답으로 보내면 Jackson(잭슨)이 이를 해석하여 JSON으로 변환하려고 하다가 계속해서 양방향 참조를 하다보니 무한 루프에 빠져서 문제가 발생한다.

#### (2) @Data / @ToString

롬복의 @Data혹은 @ToString를 통해 생성된 ToString()이 양방향 참조를 건드려서 디버깅 중에 스택오버플로우를 일으키는 경우 문제 발생.

### 2) 해결책

#### (1) DTO 반환

API 응답으로 엔티티를 직접 보내지 말고, 필요한 필드만 혹은 엔티티를 가공한 DTO를 사용하면 참조의 개념이 없기 때문에 무한 루프가 발생하지 않는다.

#### (2) @JsonIgnore

순환 참조가 발생하는 필드에 @JsonIgnore 어노테이션을 붙여서 JSON 생성 대상에서 제외할 수도 있다. 그러나 해당 필드가 응답에 필요할 경우에는 위에서 언급했듯이 DTO를 사용하는게 베스트이다.